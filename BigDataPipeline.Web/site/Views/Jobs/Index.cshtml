@{
    Layout = Url.Content ("Shared/_Layout.cshtml");
}

<div ng-app="app" ng-controller="mainController" id="mainController" ui-i18n="en">
    <h4>Jobs</h4>

    <div class="separator-8"></div>

    <div id="status" class="alert" ng-hide="status" ng-class="{'alert-success': status, 'alert-danger': !status}">{{ message }}</div>

    <div class="separator-8" ng-hide="status"></div>

    <div class="row" id="nav-jobList">
        <div class="col-sm-4">
            <button class="btn btn-default margin-right-16" role="button" ng-click="refresh()">Refresh</button>
            <button class="btn btn-default margin-right-16" role="button" ng-click="addNewJob()">Add Job</button>
        </div>

        <div class="col-sm-8">
            <input class="form-control" id="job-table-filter" type="text" placeholder="search" />
        </div>
    </div>

    <div class="separator-8"></div>


    <div class="table-responsive">
        <table class="table table-condensed table-bordered table-striped table-hover" id="job-table" data-filter="#job-table-filter" data-filter-text-only="true" data-page-size="10" data-page-navigation="#job-table-pagination">
            <thead>
                <tr>
                    <th class="text-center">Name</th>
                    <th class="text-center">Group</th>
                    <th class="text-center" data-hide="all">Description</th>
                    <th class="text-center" data-hide="phone">Enabled</th>
                    <th class="text-center" data-hide="phone,tablet">Id</th>
                    <th class="text-center" data-hide="phone" data-sort-ignore="true"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="footable hide-if-no-paging">
        <div id="job-table-pagination hide-if-no-paging" class="pagination"></div>
    </div>

    <div class="separator-16"></div>

    <div class="row" id="nav-jobDetails">
        <div class="col-sm-12">
            <div role="tabpanel">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist" id="editAreaNavTabs">
                    <li role="presentation" class="active"><a href="#editAsForm" aria-controls="editAsForm" role="tab" data-toggle="tab">Edit as Form</a></li>
                    <li role="presentation"><a href="#editAsJson" aria-controls="editAsJson" role="tab" data-toggle="tab">Edit as Json</a></li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="editAsForm">
                        <div class="separator-8"></div>
                        <div class="row">
                            <div class="col-sm-6">
                                <h3>Job details</h3>
                            </div>
                            <div class="col-sm-6">
                                <button class="btn btn-default width-50 pull-right margin-horizontal-2" role="button" ng-click="removeJob(selectedJob)"><i class="fa fa-trash-o text-danger"></i></button>
                                <button class="btn btn-default width-50 pull-right margin-horizontal-2" role="button" ng-click="cloneJob(selectedJob)"><i class="fa fa-files-o"></i></button>
                                <button class="btn btn-default width-50 pull-right margin-horizontal-2" role="button" ng-click="playJob(selectedJob)"><i class="fa fa-play"></i></button>
                                <button class="btn btn-default width-100 pull-right margin-horizontal-2" role="button" ng-click="saveCurrentJob()">Save</button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    Name:<br />
                                    <input type="text" class="form-control" ng-model="selectedJob.Name" />
                                </div>
                                <div class="form-group">
                                    Group:<br />
                                    <input type="text" class="form-control" ng-model="selectedJob.Group" />
                                </div>
                                <div class="form-group">
                                    Last Execution date/time:<br />
                                    <input type="text" class="form-control" ng-model="selectedJob.LastExecution" readonly />
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <div class="form-group">
                                    Description:<br />
                                    <textarea class="form-control" rows="10" ng-model="selectedJob.Description"></textarea>
                                </div>
                            </div>
                        </div>

                        <hr />
                        <h3>Job execution triggers</h3>

                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group" title="Enable/disable this job execution." ng-class="{'text-primary': selectedJob.Enabled, 'bg-danger': !selectedJob.Enabled}">
                                    <div class="checkbox">
                                        <label><input type="checkbox" ng-model="selectedJob.Enabled" /> Is Enabled ?</label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <div class="form-group" title="When will be the next execution of this job?">
                                    Next Scheduled Execution:<br />
                                    <div class="dropdown">
                                        <a class="dropdown-toggle" id="dropdown2" role="button" data-toggle="dropdown" data-target="#" href="#">
                                            <div class="input-group">
                                                <input type="text" class="form-control" data-ng-model="selectedJob.NextExecution"><span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                                            </div>
                                        </a>
                                        <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                                            <datetimepicker data-ng-model="selectedJob.NextExecution" data-datetimepicker-config="{ dropdownSelector: '#dropdown2' }"></datetimepicker>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group" title="When this job will be executed">
                                    Job Scheduler: <button class="btn btn-default btn-sm" role="button" ng-click="addNewScheduler()"><i class="fa fa-plus"></i></button>
                                    <div class="separator-4"></div>

                                    <ul class="list-unstyled">
                                        <li ng-repeat="cron in selectedJob.Scheduler track by $index">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" ng-model="selectedJob.Scheduler[$index]" data-index="{{ $index }}" />
                                                    <span class="input-group-btn">
                                                        <button class="btn btn-default" type="button" ng-click="editCronScheduler($index)"><i class="fa fa-pencil-square-o"></i></button>
                                                        <button class="btn btn-default" type="button" ng-click="removeScheduler($index)"><i class="fa fa-trash-o text-danger"></i></button>
                                                    </span>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <div class="form-group">
                                    Events: <button class="btn btn-default btn-sm" role="button" ng-click="addJobEvent()"><i class="fa fa-plus"></i></button>
                                    <div class="separator-4"></div>

                                    <ul class="list-unstyled">
                                        <li ng-repeat="cron in selectedJob.Events track by $index">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" ng-model="selectedJob.Events[$index]" />
                                                    <span class="input-group-btn">
                                                        <button class="btn btn-default" type="button" ng-click="removeJobEvent($index)"><i class="fa fa-trash-o text-danger"></i></button>
                                                    </span>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <hr />
                        <h3>Job settings</h3>

                        <div class="row">
                            <div class="col-sm-12">
                                <div ng-include="'optionsTable.template'" ng-repeat="tableData in [selectedJob.Options]"></div>
                            </div>
                        </div>

                        <hr />
                        <h3>Initial Action</h3>

                        <div ng-include="'actionView.template'" ng-repeat="action in [selectedJob.RootAction]"></div>

                    </div>

                    <div role="tabpanel" class="tab-pane" id="editAsJson">
                        <div class="separator-8"></div>

                        <h3>
                            JSON editor
                            <button class="btn btn-default pull-right" role="button" ng-click="parseJobFromText()">Check Syntax</button>
                        </h3>

                        <textarea class="form-control" rows="30" ng-model="jobTextContent"></textarea>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="separator-8"></div>

    <div class="form-group">
        <button class="btn btn-default width-50 pull-right margin-horizontal-2" role="button" ng-click="removeJob(selectedJob)"><i class="fa fa-trash-o text-danger"></i></button>
        <button class="btn btn-default width-50 pull-right margin-horizontal-2" role="button" ng-click="cloneJob(selectedJob)"><i class="fa fa-files-o"></i></button>
        <button class="btn btn-default width-50 pull-right margin-horizontal-2" role="button" ng-click="playJob(selectedJob)"><i class="fa fa-play"></i></button>
        <button class="btn btn-default width-100 pull-right margin-horizontal-2" role="button" ng-click="saveCurrentJob()">Save</button>
    </div>

    <!-- Hidden stuff -->
    <div style="display: none;">
        <div id="addNewJobDialog" style="width:400px;">
            <div class="container-fluid bottom_margin_10">
                <div class="form-group">
                    New Job Name:<br />
                    <input type="text" class="form-control" ng-model="newJob.Name" />
                </div>
                <div class="form-group">
                    New Job Group:<br />
                    <input type="text" class="form-control" ng-model="newJob.Group" />
                </div>
            </div>
        </div>

        <div id="cronEditorDialog" style="width:500px; height:350px;">
            <div class="container-fluid bottom_margin_10">
                <h3>Scheduler editor</h3>

                <div class="well well-sm">
                    Note: remember that the time is in <b>UTC</b>.
                </div>
                <div class="separator-4"></div>

                <div id='cronEditorDialogCtrl'></div>

                <div class="separator-16"></div>
                <b>Selected cron text: </b> <span id="cronEditorDialogCtrlText"></span>
                <div class="separator-4"></div>
            </div>
        </div>

        <div id="addKeyDialog" style="width:400px;">
            <div class="container-fluid bottom_margin_10">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="newKeyName" placeholder="key name" />
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="newKeyValue" placeholder="key value" />
                </div>
            </div>
        </div>
    </div>

    <script type="text/ng-template" id="optionsTable.template">
        <div class="table-responsive">
            <table class="table table-condensed">
                <thead>
                    <tr>
                        <th>Key</th>
                        <th>Value</th>
                        <th><button type="button" role="button" ng-click="addKey(tableData)" class="btn btn-default btn-sm"><i class="fa fa-plus"></i></button></th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="(key, value) in tableData">
                        <td><input type="text" class="form-control" ng-model="key" readonly /></td>
                        <td><input type="text" class="form-control" ng-model="tableData[key]" />
                        <td><button type="button" role="button" ng-click="removeKey(tableData, key)" class="btn btn-default btn-sm"><i class="fa fa-times text-danger"></i></button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </script>

    <script type="text/ng-template" id="actionView.template">
        <div class="row" ng-init="lastIndex= !!lastIndex ? (lastIndex + '.' + ($index + 1)) : ($index + 1)">
            <div class="col-sm-6">
                <div class="form-group">
                    Module:<br />
                    <input type="hidden" class="width-full" ng-select2-bind ng-model="action.Module" select2-query="modules.getNames()" placeholder="Select a module..." disable-validation />
                </div>
                <div class="form-group">
                    Action Options:<br />
                    <div ng-include="'optionsTable.template'" ng-repeat="tableData in [action.Options]"></div>
                </div>
                <button type="button" role="button" ng-click="addChildAction(action)" class="btn btn-default btn-sm pull-right">Add Child Action <i class="fa fa-plus"></i></button>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    Selected Module Details<br />

                    <textarea class="form-control" rows="8" readonly>{{ modules.getModule(action.Module).Description }}</textarea>

                    <div class="separator-4"></div>

                    <ul>
                        <button type="button" role="button" ng-click="addParameters(action)" class="btn btn-default btn-sm pull-right"><i class="fa fa-exchange"></i></button></i>
                        <li ng-repeat="c in modules.getModule(action.Module).Parameters track by $index">
                            {{ "{0} ({1}) - {2} - {3}".replace('{0}', c.Name || '').replace('{1}', c.Type || '').replace('{2}', c.IsRequired ? 'REQUIRED' : 'OPTIONAL').replace('{3}', c.Description || '') }}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div ng-repeat="action in action.Actions track by $index">
            <hr />
            <h4>{{lastIndex + '.' + ($index + 1)}} Subsequent Action</h4>
            <div ng-include="'actionView.template'"></div>
        </div>
    </script>
</div>


@section scripts {

    <script type="text/javascript">
        var jobHelper = {
            //hideMessage: function () {
            //    $('#status').hide();
            //},
            //showMessage: function (msg, evtType) {
            //    $('#status').html(msg)
            //        .toggleClass('alert', true)
            //        .toggleClass('alert-success', evtType === "success")
            //        .toggleClass('alert-danger', evtType === "error")
            //        .toggleClass('alert-warning', evtType === "warning")
            //        .toggleClass('alert-info', evtType || 'info' === "info")
            //        .show();
            //}
            actionCount: function (job) {
                function _count(action) {
                    if (!action) { return 0; }
                    var c = 1, i;
                    if (action.Actions) {
                        for (i = 0; i < action.Actions.length; i++) {
                            c += _count(action.Actions[i]);
                        }
                    }
                    return c;
                }
                if (!job) { return 0; }
                return _count(job.RootAction);
            }
        };

        //** angularJs initialization **
        var ng_app = angular.module('app', ['ui.bootstrap.datetimepicker']);
        ng_app.directive('ngSelect2Bind', ['$q', '$timeout', ngSelect2BindDirective]);

        //** angularJs page main controller **
        ng_app.controller('mainController', function ($scope, $http, $timeout, $compile, $q) {
            //** angularJs initialization **
            $scope.status = false;
            $scope.message = "loading...";
            $scope.jobList = [];

            //** methods and behaviors **
            $scope.executeQuery = function (url, operation, data, onsuccess, onerror) {
                var p = {
                    op: operation,
                    data: data
                };
                simpleDialog.loading();
                return $.ajax({
                    url: url,
                    cache: false,
                    async: true,
                    type: 'POST',
                    dataType: "json",
                    data: angular.toJson(p),
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        if (data && data.status) {
                            simpleDialog.close();
                            if (typeof onsuccess == 'function') {
                                $timeout(function () {
                                    onsuccess(data.result);
                                });
                            }
                        } else {
                            if (data && data.message) {
                                simpleDialog.warning(data.message);
                            } else {
                                simpleDialog.error();
                            }
                            if (typeof onerror == 'function') {
                                $timeout(function () {
                                    onerror();
                                });
                            }
                        }
                    },
                    error: function () {
                        simpleDialog.error();
                        if (typeof onerror == 'function') {
                            $timeout(function () {
                                onerror();
                            });
                        }
                    }
                });
            };

            $scope.executeJobsQuery = function (operation, data, onsuccess, onerror) {
                return $scope.executeQuery("./jobs/query", operation, data, onsuccess, onerror);
            };

            $scope.executeModulesQuery = function (operation, data, onsuccess, onerror) {
                return $scope.executeQuery("./modules/query", operation, data, onsuccess, onerror);
            };

            $scope.saveCurrentJob = function () {
                // try get selected job
                var job = $scope.selectedJob;
                if (!$scope.checkForSelectedJob(job, true)) { return; }

                // if mode is json edit, we should try a different approach
                if ($scope.currentEditMode === 'json') {
                    job = $scope.parseJobFromText();
                }
                // save
                if (job) {
                    $scope.saveJob(job);
                }
            };

            $scope.saveJob = function (job) {
                if (!job.LastExecution && job.LastExecution !== undefined) { delete job.LastExecution; }
                if (!job.NextExecution && job.NextExecution !== undefined) { delete job.NextExecution; }

                $scope.executeJobsQuery('save',
                            { 'job': angular.toJson(job) },
                            function (data) {
                                $scope.refresh();
                                simpleDialog.success('Job saved!');
                            });
            };

            $scope.removeJob = function (job, evt) {
                if (evt) { evt.stopPropagation(); }
                if (typeof job === 'string') { job = $scope.getJob(job); }
                if (!$scope.checkForSelectedJob(job, true)) { return; }

                simpleDialog.warning('Remove job <b>' + job.Name + '</b> ?<br/><br/>' + $scope.getSimpleJobDetails(job), function () {
                    $scope.executeJobsQuery('remove', { 'jobId': job.Id.toString() },
                        function (data) {
                            $scope.refresh();
                            simpleDialog.success('Job removed!<br/><br/>' + $scope.getSimpleJobDetails(job));
                        });
                });
            };

            $scope.playJob = function (job, evt) {
                if (evt) { evt.stopPropagation(); }
                if (typeof job === 'string') { job = $scope.getJob(job); }
                if (!$scope.checkForSelectedJob(job, true)) { return; }
                
                $scope.unsavedChangesValidation(job, true).then(function () {
                    simpleDialog.warning('Execute job <b>' + job.Name + '</b> ?<br/><br/>' + $scope.getSimpleJobDetails(job), function () {
                        $scope.executeJobsQuery('play', { 'jobId': job.Id.toString() },
                            function (data) {
                                $scope.refresh();
                                simpleDialog.success('Job executing...<br/><br/>' + $scope.getSimpleJobDetails(job));
                            });
                    });
                });
            };

            $scope.cloneJob = function (job, evt) {
                if (evt) { evt.stopPropagation(); }
                if (typeof job === 'string') { job = $scope.getJob(job); }
                if (!$scope.checkForSelectedJob(job, true)) { return; }

                $scope.unsavedChangesValidation(job, true).then(function () {
                    job = JSON.parse(angular.toJson(job));
                    delete job.Id; // remove the id to create a new job
                    $scope.addNewJob(job);
                });
            };

            $scope.unsavedChangesValidation = function (job, displayWarningDialog) {
                var deferred = $q.defer();
                if (!job || !$scope.selectedJob || (!job.Id && !job.Name)) {
                    deferred.resolve(job);
                } else {
                    if ((!job.Id && job.Name) || (job.Id === $scope.selectedJob.Id && angular.toJson(job) !== $scope.selectedJobSnapshot)) {
                        if (displayWarningDialog) {
                            simpleDialog.warning('Current Job some unsaved changes.<br/>Do you want to <b>continue and lose</b> any changes?',
                                function () { deferred.resolve(job); },
                                function () { deferred.reject('Current Job some unsaved changes'); });
                        } else {
                            deferred.reject('Current Job some unsaved changes');
                        }
                    } else {
                        deferred.resolve(job);
                    }
                }
                return deferred.promise;
            };

            $scope.checkForSelectedJob = function (job, displayWarningDialog) {
                if (!job || !job.Name) {
                    if (displayWarningDialog) { simpleDialog.warning('No job selected!'); }
                    // scroll page to edit area
                    $('html, body').animate({
                        scrollTop: $("#nav-jobList").offset().top
                    }, 500);
                    return false;
                }
                return true;
            };

            $scope.createJob = function () {
                return {
                    Name: '',
                    Group: '',
                    Enabled: true,
                    Options: {},
                    RootAction: {
                        Module: '',
                        Options: {}
                    }
                };
            };

            $scope.addNewJob = function (newJob) {
                $scope.newJob = newJob || $scope.createJob();
                var opts = {
                    msg: $('#addNewJobDialog'),
                    successButtonContent: 'Add',
                    onSuccess: function () {
                        if (!$scope.checkForSelectedJob ($scope.newJob, true)) { return;}
                        $timeout(function () {
                            // set new job
                            $scope.selectItem($scope.newJob);
                            // scroll page to edit area
                            $('html, body').animate({
                                scrollTop: $("#nav-jobDetails").offset().top
                            }, 500);
                        });
                    }
                };
                // show job creation dialog
                simpleDialog.show(opts);
            };

            $scope.getJob = function (id) {
                var l = $scope.jobList, i;
                for (i = 0; i < l.length; i++) {
                    if (l[i].Id === id) {
                        return l[i];
                    }
                }
                return {};
            };

            $scope.getSimpleJobDetails = function (job) {
                var jobDetails = '<ul><li>Job Id: {0}</li><li>Job Name: {1}</li><li>Job Group: {2}</li></ul>';
                return jobDetails.replace('{0}', job.Id).replace('{1}', job.Name).replace('{2}', job.Group);
            };

            $scope.showMessage = function (message, isError) {
                $scope.status = !isError;
                $scope.message = message || "";
            };

            $scope.clearItem = function () {
                $scope.selectedJob = null;
                $scope.jobTextContent = '';
            };

            $scope.selectItem = function (item) {
                if (!item) { item = $scope.createJob(); }
                if (item) {
                    if (!item.Options) { item.Options = {}; }
                    if (!item.RootAction) { item.RootAction = {}; }
                    if (!item.RootAction.Options) { item.RootAction.Options = {}; }

                    $scope.selectedJob = item;
                    $scope.selectedJobSnapshot = angular.toJson(item);
                    $scope.refreshEditAreaJson();
                } else {
                 //   $scope.clearItem();
                }
            };

            $scope.changeEditAreaMode = function (mode) {
                if (!$scope.selectedJob) { return; }
                $scope.currentEditMode = mode;
                if (mode === 'json') {
                    $scope.refreshEditAreaJson();
                } else {
                    $scope.refreshEditAreaForm();
                }
            };

            $scope.refreshEditAreaJson = function () {
                if ($scope.selectedJob) {
                    $scope.jobTextContent = angular.toJson($scope.selectedJob, true);
                }
            };

            $scope.refreshEditAreaForm = function () {
                if ($scope.selectedJob) {
                    var job = $scope.parseJobFromText();
                    if (job) {
                        $scope.selectedJob = job;
                    }
                }
            };

            $scope.refresh = function () {
                $scope.showMessage("loading...");

                $scope.executeJobsQuery('load', null,
                    function (data) {
                        $scope.showMessage('data loaded!');
                        var lastSelectedItem = $scope.selectedJob;
                        $scope.selectItem(null);
                        $scope.jobList = data;
                        // diplay data (table population and row selection)
                        $('#job-table').data('simpleTable').populateTable(data);

                        // fooTable initilization (sort and pagination)
                        if (!$('#job-table').data('footable')) {
                            $('#job-table').footable();
                        } else {
                            $('#job-table').data('footable').redraw();
                        }

                        // since we are using simpleTable and fooTable to handle table generation,
                        // we must tell angulaJs to recognize this new nodes...
                        // angularJs compile: tells angular to parse the newly created HTML nodes
                        $compile($('#job-table'))($scope);

                        // refresh selected item
                        $timeout(function () {
                            //try to keep any older selection
                            if (lastSelectedItem) {
                                var i, len;
                                for (i = 0, len = data.length; i < len; i++) {
                                    if ((!!lastSelectedItem.Id && data[i].Id === lastSelectedItem.Id) ||
                                        (!!lastSelectedItem.Name && data[i].Name === lastSelectedItem.Name)) {
                                        $('#job-table').data('simpleTable').selectRow(i);
                                        break;
                                    }
                                }
                            }
                        });
                    }, function () {
                        $scope.clearItem();
                        $scope.showMessage("Loading failled!", true);
                    });
            };

            $scope.editCronScheduler = function (index) {
                if (!$scope.selectedJob) { return; }
                if (!$scope.selectedJob.Scheduler) { $scope.selectedJob.Scheduler = []; }
                if (!$scope.selectedJob.Scheduler[index]) { $scope.selectedJob.Scheduler[index] = '0 5 * * *'; }
                $('#cronEditorDialogCtrl').cron('value', $scope.selectedJob.Scheduler[index]);
                simpleDialog.info($('#cronEditorDialog'), function () {
                    $timeout(function () { $scope.selectedJob.Scheduler[index] = $('#cronEditorDialogCtrl').cron("value"); });
                });
            };

            $scope.addNewScheduler = function () {
                if (!$scope.selectedJob) { return; }
                if (!$scope.selectedJob.Scheduler) { $scope.selectedJob.Scheduler = []; }
                $scope.selectedJob.Scheduler[$scope.selectedJob.Scheduler.length] = '';
            };

            $scope.removeScheduler = function (index) {
                if (!$scope.selectedJob) { return; }
                if (!$scope.selectedJob.Scheduler) { $scope.selectedJob.Scheduler = []; }
                $scope.selectedJob.Scheduler.splice(index, 1);
            };

            $scope.addJobEvent = function () {
                if (!$scope.selectedJob) { return; }
                if (!$scope.selectedJob.Events) { $scope.selectedJob.Events = []; }
                $scope.selectedJob.Events[$scope.selectedJob.Events.length] = '';
            };

            $scope.removeJobEvent = function (index) {
                if (!$scope.selectedJob) { return; }
                if (!$scope.selectedJob.Events) { $scope.selectedJob.Events = []; }
                $scope.selectedJob.Events.splice(index, 1);
            };

            $scope.getTableJobsHeight = function () {
                var rowHeight = 44, headerHeight = 32, totalHeight;
                // calculate current heigth
                totalHeight = ($scope.jobList.length || 1) * rowHeight + headerHeight;
                // max heigth
                if (totalHeight > 500) { totalHeight = 500; }
                // create style
                return { height: totalHeight + "px" };
            };

            $scope.parseJobFromText = function () {
                var job = null;
                try {
                    job = JSON.parse($scope.jobTextContent);
                } catch (e) {
                    simpleDialog.error('Error parsing Job, check the JSON syntax.<br/>' + e.message);
                    return null;
                }

                // intenal methods
                function copyAction(a) {
                    var a2 = {
                        Type: a.Type || 0,
                        Module: a.PluginId || '',
                        Options: a.Options || {},
                        Comments: a.Comments
                    };
                    // copy sub actions
                    if (a.Actions) {
                        a2.Actions = [];
                        var i;
                        for (i = 0; i < a.Actions.length; i++) {
                            a2.push(copyAction(a.Actions[i]));
                        }
                    }
                    return a2;
                }

                function copyBasicData(j) {
                    var c = $scope.createJob();
                    c.Id = j.Id;
                    c.Name = j.Name;
                    c.Group = j.Domain;
                    c.Description = j.Description;
                    if (j.Comments) { c.Description = (c.Description || '') + '\n' + j.Comments; }
                    c.Enabled = j.Enabled;
                    c.Options = j.Options || {};
                    if (j.Jobs && j.Jobs.length > 0) {
                        j = j.Jobs[0];
                        c.Enabled = j.Enabled;
                        if (typeof j.Scheduler === 'string') {
                            c.Scheduler = [j.Scheduler];
                        } else {
                            c.Scheduler = j.Scheduler || [];
                        }
                        c.LastExecution = j.LastExecution;
                        c.NextExecution = j.NextExecution;

                        if (j.Events) { c.Events = j.Events; }
                        if (j.Comments) { c.Description = (c.Description || '') + '\n' + j.Comments; }
                        if (j.Options) { c.Options = jQuery.extend({}, c.Options, j.Options); }

                        c.RootAction = copyAction(j.RootAction);
                    }

                    return c;
                }

                // check for old syntax and try to update
                if (!!job.Jobs) {
                    var oldJob = job;
                    if (job.Jobs.length > 1) {
                        simpleDialog.error('Error updating Job format: multiple Jobs found.<br/>Please split these jobs manually and submit each again.');
                        return;
                    }

                    job = copyBasicData(oldJob);
                    // update UI
                    $scope.selectItem(job);
                }

                return job;
            };

            $scope.addKey = function (dic, k, v) {
                $scope.newKeyName = k || '';
                $scope.newKeyValue = v || '';
                simpleDialog.info($('#addKeyDialog'), function () {
                    $timeout(function () {
                        k = $scope.newKeyName;
                        if (!k) { k = ''; }
                        dic[k] = $scope.newKeyValue || '';
                    });
                });
            };

            $scope.removeKey = function (dic, k) {
                delete dic[k];
            };

            $scope.addChildAction = function (action) {
                if (!action.Actions) { action.Actions = []; }
                action.Actions.push({});
            };

            $scope.addParameters = function (action) {
                if (!action) { return; }
                if (!action.Options) { action.Options = {}; }
                var module = $scope.modules.getModule(action.Module), i, k;
                if (module) {
                    for (i = 0; i < module.Parameters.length; i++) {
                        k = module.Parameters[i];
                        if (!action.Options[k.Name])
                            action.Options[k.Name] = '';
                    }
                }
            };

            //**
            //** define modules related operations **
            $scope.modules = {

                init: function () {
                    var _this = this;
                    return $scope.executeModulesQuery('load', null, function (data) {
                        _this.list = data;
                        _this.names = Lazy(_this.list).map(function (c) { return c.FullName; }).sort().toArray();
                    });
                },

                getNames: function () {
                    return this.names;
                },

                getModule: function (name) {
                    var l = this.list || [], i;
                    for (i = 0; i < l.length; i++) {
                        if (l[i].FullName === name) {
                            return l[i];
                        }
                    }
                    return {};
                }
            };

            //**
            //** UI components configuration **
            (function () {
                simpleDialog.defaultOptions.cancelButtonContent = 'Cancel';

                // table configuration
                $('#job-table').simpleTable({
                    customDataParser: function (i) {
                        return [i.Name, i.Group, i.Description, i.Enabled, i.Id,
                        '<button type="button" role="button" ng-click="playJob(\'' + i.Id + '\', $event)" class="btn btn-default btn-sm margin-horizontal-2"><i class="fa fa-play"></i></button>' +
                        '<button type="button" role="button" ng-click="cloneJob(\'' + i.Id + '\', $event)" class="btn btn-default btn-sm margin-horizontal-2"><i class="fa fa-files-o"></i></button>' +
                        '<button type="button" role="button" ng-click="removeJob(\'' + i.Id + '\', $event)" class="btn btn-default btn-sm margin-horizontal-2"><i class="fa fa-trash-o text-danger"></i></button>'                        
                        ];
                    },
                    onRowSelection: function (data, rowId) {
                        $timeout(function () {
                            $scope.selectItem(data);
                        });
                    }
                });

                $('#editAreaNavTabs a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                    $timeout(function () {
                        if (e.target.href.split('#')[1] === 'editAsJson') {
                            $scope.changeEditAreaMode('json');
                        } else {
                            $scope.changeEditAreaMode('form');
                        }
                    });
                });

                $('#cronEditorDialogCtrl').cron({
                    initial: "*/5 * * * *",
                    onChange: function () {
                        $('#cronEditorDialogCtrlText').text($(this).cron("value"));
                    },
                    useGentleSelect: true
                });

                $scope.selectItem(null);

                $scope.modules.init();
                $scope.refresh();
            }());
        });


        // initialization
        //$(document).ready(function () {
        //    angular.element('#mainController').scope().refresh();
        //});
    </script>
}